<!DOCTYPE html>
<html>
<head>
    <!-- Set character encoding -->
    <meta charset="UTF-8">
    <!-- Configure viewport for responsive behavior on mobile devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>LAN Live Stream (Fullscreen)</title>
    <style>
        /* Reset browser defaults and make body fill the viewport */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden; /* Prevent scrollbars */
            background-color: #000; /* Black background for cinematic feel */
            font-family: sans-serif; /* Keep for potential error messages */
            color: #fff; /* White text for errors on black background */
        }

        /* Make the video element fill its container (the body) */
        #video {
            width: 100vw; /* 100% of viewport width */
            height: 100vh; /* 100% of viewport height */
            display: block; /* Remove potential extra space below */
            object-fit: cover; /* Or 'contain'. 'cover' fills space, may crop. 'contain' shows all, may letterbox */
            background-color: #000; /* Ensure background is black */
            border: none; /* Remove border */
            /* Removed position: relative and z-index as they are likely not needed with this layout */
        }

        /* Hide the default H1 title */
        h1 {
            display: none;
        }

        /* Hide the custom button by default - rely on native controls */
         #customFullscreenBtn {
            display: none; /* Hide the custom button */
            /* Optional: Style it as an overlay if you want to keep it
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            padding: 10px 20px;
            cursor: pointer;
            background-color: rgba(0,0,0,0.7);
            color: white;
            border: 1px solid #555;
            border-radius: 5px;
            */
         }

         /* Basic styling for potential error messages */
         .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(200, 0, 0, 0.8);
            padding: 20px;
            border-radius: 5px;
            z-index: 20;
            text-align: center;
         }
    </style>
</head>
<body>
    <!-- Title removed from visible page, kept in <title> tag -->
    <!-- <h1>Live Stream</h1> -->

    <!-- Video element - width/height attributes are overridden by CSS but can be fallback -->
    <video id="video" width="1280" height="800" controls autoplay muted playsinline></video>

    <!-- Custom button is hidden by default via CSS -->
    <button id="customFullscreenBtn">Enter Fullscreen</button>

    <!-- Load hls.js from the local server -->
    <script src="/hls.js@latest"></script>

    <script>
        const video = document.getElementById('video');
        const videoSrc = '/stream.m3u8';
        let hls = null; // Keep track of hls instance

        // Function to display user-friendly errors
        function displayError(message) {
            // Remove existing error messages first
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }

            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message'; // Use class for styling
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv); // Append to body to overlay video
            video.style.display = 'none'; // Hide video element on critical error
        }


        if (Hls.isSupported()) {
            console.log("HLS.js is supported. Initializing...");
            hls = new Hls({ // Assign to the outer scope variable
                // Optional config
                // Example: Cap quality based on screen size if needed
                // capLevelToPlayerSize: true,
                // maxBufferSize: 60, // 60 seconds buffer
                // maxMaxBufferLength: 120, // Max buffer length
            });
            hls.loadSource(videoSrc);
            hls.attachMedia(video);

            hls.on(Hls.Events.MANIFEST_PARSED, function () {
                console.log("Manifest parsed. Attempting to play video.");
                video.play().catch(e => {
                    console.error("Autoplay with HLS.js failed:", e);
                    // Display a message if autoplay fails - user might need to click play
                    // Note: Muted autoplay is *usually* allowed, but policies can vary.
                    displayError("Autoplay failed. Please click the play button on the video controls.");
                    video.style.display = 'block'; // Ensure video is visible so they can click play
                });
            });

            hls.on(Hls.Events.ERROR, function (event, data) {
                console.error('HLS.js Error:', data);
                 const errorMsgBase = "Video streaming error: ";
                if (data.fatal) {
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            console.error('Fatal network error encountered, trying to recover...');
                             // Simple recovery: try reloading source after a delay
                            // setTimeout(() => hls.loadSource(videoSrc), 5000);
                             displayError(errorMsgBase + "Network problem. Check connection or stream source. Retrying...");
                             // More robust recovery might involve staggered retries or user notification
                             // For now, just display error. User might need to refresh.
                             hls.startLoad(); // Try to restart loading
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            console.error('Fatal media error encountered, trying to recover...');
                            hls.recoverMediaError();
                            displayError(errorMsgBase + "Media playback problem. Trying to recover...");
                            break;
                        default:
                            console.error('Unrecoverable HLS.js error. Destroying HLS instance.');
                            displayError(errorMsgBase + "Unrecoverable stream error. Please reload the page.");
                            if (hls) hls.destroy(); // Ensure hls is defined before destroying
                            break;
                    }
                } else {
                     // Optionally handle non-fatal errors, e.g., buffer stall
                     // console.warn('Non-fatal HLS error:', data.details);
                }
            });

        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            console.log("Native HLS playback supported (e.g., Safari). Setting src directly.");
            video.src = videoSrc;
            video.addEventListener('loadedmetadata', function () {
                console.log("Metadata loaded for native HLS. Attempting to play video.");
                 video.play().catch(e => {
                     console.error("Autoplay with native HLS failed:", e);
                     displayError("Autoplay failed. Please click the play button on the video controls.");
                     video.style.display = 'block';
                 });
            });
            video.addEventListener('error', function(e) {
                console.error('Native HLS playback error:', e);
                 let message = "An unknown video playback error occurred.";
                 if (video.error) {
                    console.error('Video error code:', video.error.code, 'Message:', video.error.message);
                     // Try to provide more specific messages based on code if needed
                    message = `Video error code ${video.error.code}. Check stream source or network.`;
                 }
                displayError(message);
            });
        } else {
            console.error("HLS playback is not supported in this browser.");
            displayError("Sorry, your browser doesn't support the required video playback technology (HLS).");
        }

        // --- Fullscreen API Logic (Optional - if you keep the custom button visible) ---
        // NOTE: This logic is still here but the button is hidden by CSS.
        // If you want the custom button, change its `display` in CSS.
        const customFullscreenBtn = document.getElementById('customFullscreenBtn');

        function openFullscreen(elem) {
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(err => console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`));
            } else if (elem.webkitRequestFullscreen) { /* Safari */
                elem.webkitRequestFullscreen().catch(err => console.error(`Error attempting to enable webkit full-screen mode: ${err.message} (${err.name})`));
            } else if (elem.msRequestFullscreen) { /* IE11 */
                elem.msRequestFullscreen();
            } else if (elem.webkitEnterFullscreen) { /* Older iOS Safari */
                 elem.webkitEnterFullscreen();
            } else {
                 console.warn("Fullscreen API is not supported on this element.");
            }
        }

        function exitFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen().catch(err => console.error(`Error attempting to exit full-screen mode: ${err.message} (${err.name})`));
            } else if (document.webkitExitFullscreen) { /* Safari */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { /* IE11 */
                document.msExitFullscreen();
            } else {
                 console.warn("Exit Fullscreen API is not supported.");
            }
        }

        const fullscreenEnabled = document.fullscreenEnabled || document.webkitFullscreenEnabled || document.msFullscreenEnabled;

        if (!fullscreenEnabled) {
             customFullscreenBtn.style.display = 'none'; // Definitely hide if not supported
             console.warn("Fullscreen mode is not enabled/supported by the browser policy or settings.");
        } else {
            customFullscreenBtn.addEventListener('click', () => {
                 // Request fullscreen on the video element for better control integration
                 if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
                     openFullscreen(video); // Request fullscreen for the video element
                 } else {
                     exitFullscreen();
                 }
            });
        }

        // Update button text based on fullscreen state changes
        function updateFullscreenButton() {
             const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement;
            if (isFullscreen) {
                customFullscreenBtn.textContent = 'Exit Fullscreen';
            } else {
                 customFullscreenBtn.textContent = 'Enter Fullscreen';
            }
        }

        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
        document.addEventListener('msfullscreenchange', updateFullscreenButton);

        // Initial button text check
        updateFullscreenButton();
        // --- End of Optional Fullscreen Button Logic ---

    </script>
</body>
</html>